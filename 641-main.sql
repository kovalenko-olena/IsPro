--main querySELECT   CASE WHEN RIGHT(DB1.CdZakaz,1)='*' THEN     CAST(LEFT(DB1.CdZakaz,LEN(DB1.CdZakaz)-1) AS NUMERIC)   ELSE     CAST(DB1.CdZakaz AS numeric)   END AS CdZakaz,   DB1.Zakaz,   DB1.CdZakaz AS cd,   KOL1 AS 'КОЛОННА1 МОТОЧАСЫ',   KOL2 AS 'КОЛОННА2 МОТОЧАСЫ',   KOL3 AS 'КОЛОННА3 МОТОЧАСЫ',   KOL4 AS 'КОЛОННА4 МОТОЧАСЫ' FROM   /*ТРАНСПОНИРОВАНИЕ*/   (SELECT      CdZakaz,      Zakaz,      SUM([колона №1]) AS KOL1,      SUM([колона №2]) AS KOL2,      SUM([колона №3]) AS KOL3,      SUM([колона №4]) AS KOL4,      SUM(tkm) AS 'tkm'   FROM      (SELECT         CdZakaz,         Zakaz,         Kolonna,         timmth,         tkm       FROM         (SELECT            CASE WHEN Ptn_Cd is null THEN '0' ELSE Ptn_Cd END AS CdZakaz,            CASE WHEN Ptn_Nm is null THEN 'заказчик не определен' ELSE Ptn_Nm END AS Zakaz,            PLst_ClnNm AS Kolonna,            /*затребованное время работы*/            PlPrb_TimWrk AS timmth,            plst_tkm AS tkm          FROM PLST          INNER JOIN UFPRV   ON PLst_Rcd=UF_TblRcd          INNER JOIN UFRKV   ON UFRKV.UFR_DbRcd=ufprv.UF_TblId and UFRKV.UFR_RkRcd=ufprv.UF_RkRcd          LEFT JOIN PTNRK    ON ufprv.UF_RkValS = PTNRK.Ptn_CdSrt and UFR_SysSpr=1          LEFT JOIN ATPPLPRB ON ATPPLPRB.PlPrb_PLRcd=PLST.PLst_Rcd          --поле заказчик          WHERE UFRKV.UFR_RkRcd=78            and plst_rcd in (541294,541134,541135,541136,541140,541142,541206,541212,541213,541214,541144,541145,541366,541126,541127,542198,541287,541128,541130,541131,541133,541295,541296,541298,541299,541300,541301,541302,541303,541304,541305,541306,541307,541308,541309,541310,541311,541312,541313,541314,541315,541316,541318,541319,541320,541321,541322,541323,541324,541325,541326,541327,541328,541329,541330,541331,541332,541333,541334,541335,541336,541337,541338,541339,541340,541341,541342,541343,541343)         ) BDZak    /*база заполненного поля заказчик*/       UNION ALL       SELECT         CdZakaz,         Zakaz,         Kolonna,         timmth,         tkm       FROM         (SELECT            CASE WHEN Ptn_Cd is null THEN '0' ELSE Ptn_Cd END AS CdZakaz,            CASE WHEN Ptn_Nm is null THEN 'заказчик не определен' ELSE Ptn_Nm END AS Zakaz,            PLst_ClnNm AS Kolonna,            AtpZvs_TimeSF AS timmth,            0 AS tkm          FROM ATPZVS          INNER JOIN PLST ON AtpZvs_PLstRcd=PLst_Rcd          INNER JOIN PTNRK ON AtpZvs_Ptn=PTNRK.Ptn_Rcd          WHERE plst_rcd in (541294,541134,541135,541136,541140,541142,541206,541212,541213,541214,541144,541145,541366,541126,541127,542198,541287,541128,541130,541131,541133,541295,541296,541298,541299,541300,541301,541302,541303,541304,541305,541306,541307,541308,541309,541310,541311,541312,541313,541314,541315,541316,541318,541319,541320,541321,541322,541323,541324,541325,541326,541327,541328,541329,541330,541331,541332,541333,541334,541335,541336,541337,541338,541339,541340,541341,541342,541343,541343)         ) BDZad   /*база строк заданий*/       UNION ALL       SELECT         CASE WHEN Ptn_Cd is null THEN '0' ELSE Ptn_Cd END AS CdZakaz,         CASE WHEN Ptn_Nm is null THEN 'заказчик не определен' ELSE Ptn_Nm END AS Zakaz, 		PLst_ClnNm AS Kolonna, 		SUM(BDmoto.UF_RkValN) AS timmth, 		SUM(BDtkm.UF_RkValN) AS tkm      FROM         (SELECT U2.UFR_Rcd,UF_TblRcd          FROM UFRstVal U2          LEFT JOIN  UFRSTNST U10 ON U2.UF_RkRcd=U10.UFR_RkRcd          WHERE U2.UF_TblRcd in (541294,541134,541135,541136,541140,541142,541206,541212,541213,541214,541144,541145,541366,541126,541127,542198,541287,541128,541130,541131,541133,541295,541296,541298,541299,541300,541301,541302,541303,541304,541305,541306,541307,541308,541309,541310,541311,541312,541313,541314,541315,541316,541318,541319,541320,541321,541322,541323,541324,541325,541326,541327,541328,541329,541330,541331,541332,541333,541334,541335,541336,541337,541338,541339,541340,541341,541342,541343,541343)         GROUP BY U2.UFR_Rcd,UF_TblRcd)BDrcd /*база без повторов, Rcd путевых листов и Rcd записей*/       LEFT JOIN         (SELECT  U2.UFR_Rcd AS UFR_Rcd,UF_TblRcd,UF_RkRcd,UF_RkValS          FROM UFRstVal U2          LEFT JOIN  UFRSTNST U10 ON U2.UF_RkRcd=U10.UFR_RkRcd          WHERE U2.UF_TblRcd in (541294,541134,541135,541136,541140,541142,541206,541212,541213,541214,541144,541145,541366,541126,541127,542198,541287,541128,541130,541131,541133,541295,541296,541298,541299,541300,541301,541302,541303,541304,541305,541306,541307,541308,541309,541310,541311,541312,541313,541314,541315,541316,541318,541319,541320,541321,541322,541323,541324,541325,541326,541327,541328,541329,541330,541331,541332,541333,541334,541335,541336,541337,541338,541339,541340,541341,541342,541343,541343)         ) BDzak     /*база строковых значений, заказчик*/          ON BDzak.UFR_Rcd=BDrcd.UFR_Rcd and BDzak.UF_TblRcd=BDrcd.UF_TblRcd and UF_RkValS<>'' and BDzak.UF_RkRcd=3       LEFT JOIN         (SELECT   U2.UFR_Rcd AS UFR_Rcd,UF_TblRcd, UF_RkRcd, UF_RkValN          FROM UFRstVal U2          LEFT JOIN  UFRSTNST U10 ON U2.UF_RkRcd=U10.UFR_RkRcd          WHERE U2.UF_TblRcd in (541294,541134,541135,541136,541140,541142,541206,541212,541213,541214,541144,541145,541366,541126,541127,542198,541287,541128,541130,541131,541133,541295,541296,541298,541299,541300,541301,541302,541303,541304,541305,541306,541307,541308,541309,541310,541311,541312,541313,541314,541315,541316,541318,541319,541320,541321,541322,541323,541324,541325,541326,541327,541328,541329,541330,541331,541332,541333,541334,541335,541336,541337,541338,541339,541340,541341,541342,541343,541343)         ) BDmoto    /*база числовых значений, Rcd=1 моточасы*/          ON BDmoto.UFR_Rcd=BDzak.UFR_Rcd and BDmoto.UF_TblRcd=BDzak.UF_TblRcd and BDmoto.UF_RkValN<>0 and BDmoto.UF_RkRcd=1       LEFT JOIN         (SELECT U2.UFR_Rcd AS UFR_Rcd,UF_TblRcd, UF_RkRcd, UF_RkValN          FROM UFRstVal U2          LEFT JOIN  UFRSTNST U10 ON U2.UF_RkRcd=U10.UFR_RkRcd 		 WHERE U2.UF_TblRcd in (541294,541134,541135,541136,541140,541142,541206,541212,541213,541214,541144,541145,541366,541126,541127,542198,541287,541128,541130,541131,541133,541295,541296,541298,541299,541300,541301,541302,541303,541304,541305,541306,541307,541308,541309,541310,541311,541312,541313,541314,541315,541316,541318,541319,541320,541321,541322,541323,541324,541325,541326,541327,541328,541329,541330,541331,541332,541333,541334,541335,541336,541337,541338,541339,541340,541341,541342,541343,541343)         ) BDtkm   /*база числовых значений,  Rcd=2 ткм*/          ON BDtkm.UFR_Rcd=BDzak.UFR_Rcd and BDtkm.UF_TblRcd=BDzak.UF_TblRcd and BDtkm.UF_RkValN <>0 and BDtkm.UF_RkRcd=2       INNER JOIN PLST ON BDrcd.UF_TblRcd=PLst_Rcd       INNER JOIN PTNRK ON UF_RkValS=PTNRK.Ptn_cd       GROUP BY BDrcd.UF_TblRcd, BDzak.UF_RkValS,         CASE WHEN Ptn_Cd is null THEN '0' ELSE Ptn_Cd end,         CASE WHEN Ptn_Nm is null THEN 'заказчик не определен' ELSE Ptn_Nm end,         PLst_ClnNm       )DBreestr /*сгруппированная база из реестра пользователя*/               PIVOT (SUM(timmth) FOR Kolonna IN      ([КОЛОНА №1],[КОЛОНА №2],[КОЛОНА №3],[КОЛОНА №4])) pvt      GROUP BY CdZakaz, Zakaz   )DB1  ORDER BY    CASE WHEN RIGHT(DB1.CdZakaz,1)='*' THEN      CAST(LEFT(DB1.CdZakaz,len(DB1.CdZakaz)-1) AS numeric)    ELSE      CAST(DB1.CdZakaz AS numeric)    END 